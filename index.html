<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SLBingoBoardGen</title>
  <script src="ran.min.js"></script>
  <link rel="stylesheet" href="css/pico.min.css">

  <script>
    function fallbackCopyTextToClipboard(text) {
      var textArea = document.createElement("textarea");
      textArea.value = text;

      // Avoid scrolling to bottom
      textArea.style.top = "0";
      textArea.style.left = "0";
      textArea.style.position = "fixed";

      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();

      try {
        var successful = document.execCommand('copy');
        var msg = successful ? 'successful' : 'unsuccessful';
        console.log('Fallback: Copying text command was ' + msg);
      } catch (err) {
        console.error('Fallback: Oops, unable to copy', err);
      }

      document.body.removeChild(textArea);
    }
    function copyTextToClipboard(text) {
      if (!navigator.clipboard) {
        fallbackCopyTextToClipboard(text);
        return;
      }
      navigator.clipboard.writeText(text).then(function () {
        console.log('Async: Copying to clipboard was successful!');
      }, function (err) {
        console.error('Async: Could not copy text: ', err);
      });
    }
  </script>

  <script>
    const data = [{ "ban": [], "name": "Pull 1 fire alarm ", "level": [], "time": 1, "gencat": ["smp"], "sad": [], "conflict": ["smp"] }, { "ban": [], "name": "Create a paradox ", "level": ["whi"], "time": 1, "gencat": ["smp"], "sad": [], "conflict": ["smp"] }, { "ban": [], "name": "Collect 1 fire extinguisher ", "level": [], "time": 1, "gencat": ["smp"], "sad": [], "conflict": ["smp"] }, { "ban": [], "name": "Finish retro (click the alarm) ", "level": ["ret"], "time": 1, "gencat": ["smp"], "sad": [], "conflict": ["smp"] }, { "ban": [], "name": "Get a diet soda ", "level": [], "time": 1, "gencat": ["smp"], "sad": [], "conflict": ["smp"] }, { "ban": [], "name": "1 Egg + 1 Chess", "level": [], "time": 2, "gencat": ["1p1"], "sad": [], "conflict": ["1p1"] }, { "ban": [], "name": "1 Chess + 1 Constellation", "level": [], "time": 3, "gencat": ["1p1"], "sad": [], "conflict": ["1p1"] }, { "ban": [], "name": "1 Constellation + 1 Blueprint", "level": [], "time": 3, "gencat": ["1p1"], "sad": [], "conflict": ["1p1"] }, { "ban": [], "name": "1 Blueprint + 1 Egg", "level": [], "time": 2, "gencat": ["1p1"], "sad": [], "conflict": ["1p1"] }, { "ban": [], "name": "All the extinguishers in any level ", "level": ["whi"], "time": 5, "gencat": [], "sad": [], "conflict": ["an1"] }, { "ban": [], "name": "All the alarms in any level ", "level": ["whi"], "time": 5, "gencat": [], "sad": [], "conflict": ["an1"] }, { "ban": [], "name": "Please recycle: Put a soda can in the wrong place ", "level": [], "time": 1, "gencat": ["sachv"], "sad": [], "conflict": [] }, { "ban": [], "name": "Environment saved!: Place a soda can in a recycling bin ", "level": [], "time": 1, "gencat": ["sachv"], "sad": [], "conflict": [] }, { "ban": [], "name": "Cubism: Blueprint #2 (end) ", "level": ["cub"], "time": 4.5, "gencat": [], "sad": [], "conflict": [] }, { "ban": [], "name": "Whitespace: 1 Blueprint ", "level": ["whi"], "time": 2.6, "gencat": [], "sad": [], "conflict": ["wb"] }, { "ban": [], "name": "Cubism: Any blueprint ", "level": ["cub"], "time": 6.5, "gencat": [], "sad": [], "conflict": [] }, { "ban": [], "name": "Optical: Blueprint #1 (exit sign ramp) ", "level": ["opt"], "time": 4, "gencat": [], "sad": [], "conflict": [] }, { "ban": [], "name": "Blackout: Blueprint ", "level": ["bla"], "time": 15, "gencat": [], "sad": [], "conflict": [] }, { "ban": [], "name": "Cubism: Red Queen ", "level": ["cub"], "time": 5, "gencat": [], "sad": [], "conflict": ["cqk"] }, { "ban": [], "name": "Cubism: Red King ", "level": ["cub"], "time": 5, "gencat": [], "sad": [], "conflict": ["cqk"] }, { "ban": [], "name": "Whitespace: Blue Pawn (Jungles' Bistro) ", "level": ["whi"], "time": 2.5, "gencat": [], "sad": [], "conflict": [] }, { "ban": [], "name": "Whitespace: Blue Rook (vending machine) ", "level": ["whi"], "time": 1.7, "gencat": [], "sad": [], "conflict": [] }, { "ban": [], "name": "Cubism Egg ", "level": ["cub"], "time": 2, "gencat": [], "sad": ["segg"], "conflict": [] }, { "ban": [], "name": "Optical Egg #1 (hallway) ", "level": ["opt"], "time": 3, "gencat": [], "sad": ["segg"], "conflict": [] }, { "ban": [], "name": "Optical Egg #2 (exit sign ramp) ", "level": ["opt"], "time": 4, "gencat": [], "sad": ["segg"], "conflict": [] }, { "ban": [], "name": "Whitespace Egg :pain: ", "level": ["whi"], "time": 4, "gencat": [], "sad": ["segg"], "conflict": [] }, { "ban": [], "name": "Blackout: Cheese Constellation ", "level": ["bla"], "time": 3, "gencat": [], "sad": ["scon"], "conflict": [] }, { "ban": [], "name": "Cubism: Cup Constellation ", "level": ["cub"], "time": 3.4, "gencat": [], "sad": ["scon"], "conflict": [] }, { "ban": [], "name": "Whitespace: Piano Constellation ", "level": ["whi"], "time": 6.5, "gencat": [], "sad": ["scon"], "conflict": [] }, { "ban": [], "name": "Dollhouse: Chair Constellation ", "level": ["dol"], "time": 3.5, "gencat": [], "sad": ["scon"], "conflict": [] }, { "ban": [], "name": "Clone: Any chess piece ", "level": ["clo"], "time": 7, "gencat": [], "sad": ["sche"], "conflict": ["clochess"] }, { "ban": [], "name": "Clone: Blue Pawn ", "level": ["clo"], "time": 7, "gencat": [], "sad": ["sche"], "conflict": ["clochess"] }, { "ban": [], "name": "Clone: Red Knight ", "level": ["clo"], "time": 10, "gencat": [], "sad": ["sche"], "conflict": ["clochess"] }, { "ban": [], "name": "Induction: Blue Pawn ", "level": ["ind"], "time": 4.5, "gencat": [], "sad": ["sche"], "conflict": [] }, { "ban": [], "name": "Whitespace: Red Pawn (end) ", "level": ["whi"], "time": 4.5, "gencat": [], "sad": ["sche"], "conflict": [] }, { "ban": [], "name": "A king & a queen ", "level": ["cub"], "time": 6, "gencat": [], "sad": [], "conflict": ["cqk"] }, { "ban": [], "name": "Whitespace: 2 Blueprints ", "level": ["whi"], "time": 4.5, "gencat": [], "sad": ["sble"], "conflict": [] }, { "ban": [], "name": "Labyrinth: 1 Blueprint ", "level": ["lab", "longlab"], "time": 21, "gencat": [], "sad": ["sble"], "conflict": [] }, { "ban": [], "name": "Labyrinth: 2 Blueprints ", "level": ["lab", "longlab"], "time": 23, "gencat": [], "sad": ["sble"], "conflict": [] }, { "ban": [], "name": "Dollhouse: 1 Blueprint ", "level": ["dol"], "time": 10, "gencat": [], "sad": ["sble"], "conflict": [] }, { "ban": [], "name": "A duck (Cubism) ", "level": ["cub"], "time": 6, "gencat": ["fun"], "sad": [], "conflict": [] }, { "ban": [], "name": "A banana (Clone) ", "level": ["clo", "longclo"], "time": 11, "gencat": ["fun"], "sad": [], "conflict": [] }, { "ban": [], "name": "A Spintop (Whitespace) ", "level": ["whi", "longwhi"], "time": 10, "gencat": ["fun"], "sad": [], "conflict": [] }, { "ban": [], "name": "A tiny banana (Whitespace) ", "level": ["whi"], "time": 6, "gencat": ["fun"], "sad": [], "conflict": [] }, { "ban": [], "name": "Play the piano (Dollhouse) ", "level": ["dol", "longdol"], "time": 14, "gencat": ["fun"], "sad": [], "conflict": [] }, { "ban": [], "name": "Wake Up: Entirety of Retrospect cutscene ", "level": [], "time": 20, "gencat": [], "sad": [], "conflict": [] }, { "ban": [], "name": "Vaguely activated achievement: Who knows? ", "level": [], "time": 12, "gencat": [], "sad": [], "conflict": [] }, { "ban": [], "name": "Complete Induction ", "level": ["ind"], "time": 9, "gencat": ["1level"], "sad": ["mwarp"], "conflict": ["find"] }, { "ban": [], "name": "Complete Optical", "level": ["opt"], "time": 6, "gencat": ["1level"], "sad": ["mwarp"], "conflict": ["fopt"] }, { "ban": [], "name": "Complete Cubism", "level": ["cub"], "time": 9, "gencat": ["1level"], "sad": ["mwarp"], "conflict": ["fcub"] }, { "ban": [], "name": "Complete Blackout ", "level": ["bla"], "time": 15, "gencat": ["1level"], "sad": ["mwarp"], "conflict": ["fbla"] }, { "ban": [], "name": "Complete Dollhouse ", "level": ["dol"], "time": 6, "gencat": ["1level"], "sad": ["mwarp"], "conflict": ["fdol"] }, { "ban": [], "name": "Complete Labyrinth ", "level": ["lab"], "time": 6, "gencat": ["1level"], "sad": ["mwarp"], "conflict": ["flab"] }, { "ban": [], "name": "Complete Whitespace ", "level": ["whi"], "time": 4, "gencat": ["1level"], "sad": ["mwarp"], "conflict": ["fwhi"] }, { "ban": [], "name": "Complete Induction Glitchlessly", "level": ["longind"], "time": 11, "gencat": ["1level"], "sad": ["gless"], "conflict": ["find"] }, { "ban": [], "name": "Complete Optical Glitchlessly", "level": ["longopt"], "time": 13, "gencat": ["1level"], "sad": ["gless"], "conflict": ["fopt"] }, { "ban": [], "name": "Complete Cubism Glitchlessly", "level": ["longcub"], "time": 11, "gencat": ["1level"], "sad": ["gless"], "conflict": ["fcub"] }, { "ban": [], "name": "Complete Blackout Glitchlessly", "level": ["longbla"], "time": 17, "gencat": ["1level"], "sad": ["gless"], "conflict": ["fbla"] }, { "ban": [], "name": "Complete Clone Glitchlessly", "level": ["longclo"], "time": 14, "gencat": ["1level"], "sad": ["gless"], "conflict": ["fclo"] }, { "ban": [], "name": "Complete Dollhouse Glitchlessly", "level": ["longdol"], "time": 14, "gencat": ["1level"], "sad": ["gless"], "conflict": ["fdol"] }, { "ban": [], "name": "Complete Labyrinth Glitchlessly", "level": ["longlab"], "time": 24, "gencat": ["1level"], "sad": ["gless"], "conflict": ["flab"] }, { "ban": [], "name": "Complete Whitespace Glitchlessly", "level": ["longwhi"], "time": 30, "gencat": ["1level"], "sad": ["gless"], "conflict": ["fwhi"] }, { "ban": [], "name": "Cubism: Blueprint #1 (ventilation) ", "level": ["cub"], "time": 6, "gencat": [], "sad": ["sble2"], "conflict": [] }, { "ban": [], "name": "Induction: Blueprint ", "level": ["ind", "longind"], "time": 10, "gencat": [], "sad": ["sble2"], "conflict": [] }, { "ban": [], "name": "Dollhouse: 2 Blueprints ", "level": ["dol", "longdol"], "time": 14, "gencat": [], "sad": ["sble2"], "conflict": [] }, { "ban": [], "name": "Optical: Blueprint #2 (moon room) ", "level": ["opt", "longopt"], "time": 14, "gencat": [], "sad": ["sble2"], "conflict": [] }, { "ban": [], "name": "Why are you like this?: Clone an item too many times ", "level": ["clo"], "time": 10, "gencat": ["sachv"], "sad": ["achv2"], "conflict": [] }, { "ban": [], "name": "Sugar crash: Break a soda can ", "level": [], "time": 2, "gencat": ["sachv"], "sad": ["achv2"], "conflict": [] }, { "ban": [], "name": "Please use other door: Wrong door in Optical ", "level": ["opt"], "time": 8, "gencat": ["sachv"], "sad": ["achv2"], "conflict": [] }, { "ban": [], "name": "Son of man: Drop an apple on your head ", "level": ["clo"], "time": 6, "gencat": ["sachv"], "sad": ["achv2"], "conflict": [] }, { "ban": [], "name": ":) smily face cursor in Clone ", "level": ["clo"], "time": 6, "gencat": ["sachv"], "sad": ["achv3"], "conflict": [] }, { "ban": [], "name": "Soda Connaisseur: Drink all sodas ", "level": [], "time": 4, "gencat": ["sachv"], "sad": ["achv3"], "conflict": [] }, { "ban": [], "name": "Get a bonus soda ", "level": [], "time": 5, "gencat": ["sachv"], "sad": ["achv3"], "conflict": [] }, { "ban": [], "name": "Expert fire alarmist: Pull enough fire alarms ", "level": ["x"], "time": 8, "gencat": ["sachv"], "sad": ["achv3"], "conflict": [] }, { "ban": [], "name": "Optical: Table Constellation ", "level": ["opt"], "time": 10, "gencat": [], "sad": ["scon2"], "conflict": [] }, { "ban": [], "name": "Labyrinth: Light Projector Constellation ", "level": ["lab", "longlab"], "time": 27, "gencat": [], "sad": ["scon2"], "conflict": [] }, { "ban": [], "name": "Clone: Soda Machine Constellation ", "level": ["clo"], "time": 13, "gencat": [], "sad": ["scon2"], "conflict": [] }, { "ban": [], "name": "3 Constellations ", "level": [], "time": 5, "gencat": ["cnta"], "sad": ["scon2"], "conflict": ["cntcon"] }, { "ban": [], "name": "15 fire extinguishers ", "level": [], "time": 5, "gencat": ["cnta"], "sad": [], "conflict": ["cntext"] }, { "ban": [], "name": "12 fire alarms ", "level": [], "time": 4, "gencat": ["cnta"], "sad": [], "conflict": ["cntalm"] }, { "ban": [], "name": "5 chess pieces ", "level": [], "time": 12, "gencat": ["cnta"], "sad": [], "conflict": ["cntche"] }, { "ban": ["ch"], "name": "4 mini challenges in challenge mode ", "level": [], "time": 10, "gencat": ["cnta"], "sad": ["sch"], "conflict": ["cntch"] }, { "ban": [], "name": "Blackout: Both Blue Pawns ", "level": ["bla", "longbla"], "time": 18, "gencat": ["blapawn"], "sad": ["sche2"], "conflict": [] }, { "ban": [], "name": "Blackout: Blue Pawn #1 (blind maze) ", "level": ["bla", "longbla"], "time": 13, "gencat": ["blapawn"], "sad": ["sche2"], "conflict": [] }, { "ban": [], "name": "Blackout: Blue Pawn #2 (window) ", "level": ["bla", "longbla"], "time": 18, "gencat": ["blapawn"], "sad": ["sche2"], "conflict": [] }, { "ban": [], "name": "Optical: Red Rook ", "level": ["opt"], "time": 8, "gencat": [], "sad": ["sche2"], "conflict": [] }, { "ban": [], "name": "Labyrinth: Red Pawn ", "level": ["lab"], "time": 14, "gencat": [], "sad": ["sche2"], "conflict": [] }, { "ban": [], "name": "Labyrinth: Blue King ", "level": ["lab", "longlab"], "time": 24, "gencat": [], "sad": ["sche2"], "conflict": [] }, { "ban": [], "name": "Clone Egg (end) ", "level": ["clo", "longclo"], "time": 15, "gencat": [], "sad": ["segg2"], "conflict": [] }, { "ban": [], "name": "Labyrinth Egg #2 (HALL 5) ", "level": ["longlab"], "time": 20, "gencat": [], "sad": ["segg2"], "conflict": [] }, { "ban": [], "name": "Labyrinth Egg #3 (dropdown) ", "level": ["longlab"], "time": 20, "gencat": [], "sad": ["segg2"], "conflict": [] }, { "ban": [], "name": "Optical: Blue Knight ", "level": ["opt", "longopt"], "time": 12, "gencat": [], "sad": ["sche2"], "conflict": [] }, { "ban": [], "name": "Dollhouse: Blue Pawn ", "level": ["dol"], "time": 10, "gencat": [], "sad": ["sche2"], "conflict": [] }, { "ban": [], "name": "All minor collectibles in Optical ", "level": ["opt"], "time": 10, "gencat": [], "sad": [], "conflict": ["amc"] }, { "ban": [], "name": "All minor collectibles in Cubism ", "level": ["cub"], "time": 10, "gencat": [], "sad": [], "conflict": ["amc"] }, { "ban": [], "name": "All minor collectibles in Clone ", "level": ["clo"], "time": 10, "gencat": [], "sad": [], "conflict": ["amc"] }, { "ban": [], "name": "All minor collectibles in Labyrinth ", "level": ["lab"], "time": 10, "gencat": [], "sad": [], "conflict": ["amc"] }, { "ban": [], "name": "20 fire alarms ", "level": [], "time": 15, "gencat": ["cntb"], "sad": [], "conflict": ["cntalm"] }, { "ban": [], "name": "25 fire extinguishers ", "level": [], "time": 15, "gencat": ["cntb"], "sad": [], "conflict": ["cntext"] }, { "ban": [], "name": "4 constellations ", "level": [], "time": 9, "gencat": ["cntb"], "sad": [], "conflict": ["cntcon"] }, { "ban": [], "name": "5 Blueprints ", "level": [], "time": 9, "gencat": ["cntb"], "sad": [], "conflict": ["cntble"] }, { "ban": [], "name": "7 chess pieces ", "level": [], "time": 9, "gencat": ["cntb"], "sad": [], "conflict": ["cntche"] }, { "ban": ["ch"], "name": "9 mini challenges in challenge mode ", "level": [], "time": 14, "gencat": ["cntb"], "sad": [], "conflict": ["cntch"] }, { "ban": [], "name": "All Collectibles in Dollhouse ", "level": [], "time": 20, "gencat": [], "sad": [], "conflict": [] }, { "ban": [], "name": "5 Pawns ", "level": [], "time": 10, "gencat": ["speche"], "sad": [], "conflict": ["speche"] }, { "ban": [], "name": "5 Blue Pieces ", "level": [], "time": 10, "gencat": ["speche"], "sad": [], "conflict": ["speche"] }, { "ban": [], "name": "5 Red Pieces ", "level": [], "time": 10, "gencat": ["speche"], "sad": [], "conflict": ["speche"] }, { "ban": [], "name": "1 Piece of each type (KQRNp) ", "level": [], "time": 15, "gencat": ["speche"], "sad": [], "conflict": ["speche"] }, { "ban": [], "name": "Bring the :pain: egg to the end of Whitespace ", "level": [], "time": 16, "gencat": ["seminm"], "sad": [], "conflict": [] }, { "ban": ["ch"], "name": "Challenge Mode Blackout ", "level": [], "time": 22, "gencat": ["seminm"], "sad": [], "conflict": [] }, { "ban": [], "name": "Pure black screen in a level (cursor too)", "level": [], "time": 5, "gencat": ["seminm"], "sad": [], "conflict": [] }, { "ban": [], "name": "Keep falling (sound) for 20 seconds ", "level": [], "time": 4, "gencat": ["seminm"], "sad": [], "conflict": [] }, { "ban": [], "name": "Jumpless: Any level without jumping (not retro) ", "level": [], "time": 20, "gencat": [], "sad": ["catext"], "conflict": [] }, { "ban": [], "name": "Back%: Any level but you can only walk backwards (not retro) ", "level": [], "time": 15, "gencat": [], "sad": ["catext"], "conflict": [] }, { "ban": [], "name": "Crab%: Any level but you can only walk left or right (not retro) ", "level": [], "time": 15, "gencat": [], "sad": ["catext"], "conflict": [] }, { "ban": [], "name": "Mouse%: Any level with only a mouse (not retro) ", "level": [], "time": 15, "gencat": [], "sad": ["catext"], "conflict": [] }, { "ban": [], "name": "All Easter Eggs in Optical & Labyrinth ", "level": ["longlab", "longopt"], "time": 30, "gencat": ["nm"], "sad": [], "conflict": [] }, { "ban": [], "name": "Superluminal: Beat the game in under 30 minutes ", "level": [], "time": 45, "gencat": ["nm"], "sad": [], "conflict": [] }, { "ban": [], "name": "52 fire alarms ", "level": [], "time": 30, "gencat": ["nm"], "sad": [], "conflict": ["cntalm"] }, { "ban": [], "name": "69 fire extinguishers ", "level": [], "time": 30, "gencat": ["nm"], "sad": [], "conflict": ["cntext"] }, { "ban": [], "name": "All 7 constellations ", "level": [], "time": 30, "gencat": ["nm"], "sad": [], "conflict": ["cntcon"] }, { "ban": [], "name": "Avocado (in Dollhouse secret room) ", "level": [], "time": 40, "gencat": ["nm"], "sad": [], "conflict": ["cntble"] }, { "ban": ["ch"], "name": "25 mini challenges in challenge mode ", "level": [], "time": 65, "gencat": ["nm"], "sad": [], "conflict": ["cntch"] }, { "ban": [], "name": "Kasparov: Make the last move ", "level": [], "time": 40, "gencat": ["nm"], "sad": [], "conflict": ["cntche"] }];
    const gencats = [...new Set(data.map(x => x.gencat).flat().filter(x => x !== ""))];
    const magic_square = [[17, 24, 1, 8, 15], [23, 5, 7, 14, 16], [4, 6, 13, 20, 22], [10, 12, 19, 21, 3], [11, 18, 25, 2, 9]].map(x => x.map(y => y - 1));

    // Global state
    let output_str = "Output Here";
    let gen_length = "medium";
    let seed = Math.floor(Math.random() * 100000000);

    let bias = 0.6;

    let ban_ch = false;

    let bans = [];

    let pred_length = 0;

    // Utility Function
    const transpose = m => m[0].map((x, i) => m.map(x => x[i]));

    function att_function(x) {
      return Math.pow(0.5, Math.min(x, 4));
    }

    function clone(x) {
      return JSON.parse(JSON.stringify(x));
    }

    function output_board(s, x) {
      let board = clone(s);
      board.sort((a, b) => b.time - a.time);
      board = magic_square.map(x => x.map(y => board[y]));
      ranjs.core.shuffle(board);
      board = transpose(board);
      ranjs.core.shuffle(board);
      board = board.flat();
      let output = JSON.stringify(board.map(x => ({ name: x.name.trim() })));
      output_str = output;
      pred_length = x;
      upupdate(); 
    }

    function gen_dist(x, prob) {
      let list;
      if (typeof prob === 'function') {
        list = x.map(prob);
      } else {
        list = prob;
      }
      const sum = list.reduce((a, b) => a + b, 0);
      let choice = ranjs.core.float(sum);
      for (let i = 0; i < x.length; i++) {
        if (choice < list[i]) {
          return x[i];
        }
        choice -= list[i];
      }
      return x[x.length - 1];
    }

    function bias_func() {
      return x => Math.pow(x.time, bias);
    }

    function remove_conflict(x, conf) {
      return x.filter(y => !y.conflict.some(z => conf.includes(z)));
    }

    function gen1() {
      let board = [];
      let candidates = clone(data).filter(x => !x.ban.some(y => bans.includes(y)));
      let sadness_count = {};

      let my_gencats = clone(gencats);
      ranjs.core.shuffle(my_gencats);

      for (let cat of my_gencats) {
        let cat_candidates = candidates.filter(x => x.gencat.includes(cat));
        let current = gen_dist(cat_candidates, bias_func());
        candidates = candidates.filter(x => x !== current);
        board.push(current);
        candidates = remove_conflict(candidates, current.conflict);
        for (let sad of current.sad) {
          if (sadness_count[sad] === undefined) {
            sadness_count[sad] = 0;
          }
          sadness_count[sad]++;
        }
      }

      while (board.length < 25) {
        candidates = candidates.filter(x => !x.sad.some(y => sadness_count[y] >= 2));
        let current = gen_dist(candidates, bias_func());
        candidates = candidates.filter(x => x !== current);
        board.push(current);
        candidates = remove_conflict(candidates, current.conflict);
        for (let sad of current.sad) {
          if (sadness_count[sad] === undefined) {
            sadness_count[sad] = 0;
          }
          sadness_count[sad]++;
        }
      }

      return board;
    }

    function LogisticSigmoid(x) {
      return 1 / (1 + Math.exp(-x));
    }

    // Super secret function to predict the score of a board
    // from a bias value
    function board_predict(x) {
      return 17.009826017541112
        + Math.exp(3.319643309680599 - Math.pow(0.43659045992741885 - 0.5216580015897554 * x, 2))
        + 288.73265593395223 * LogisticSigmoid(-2.0549890612293535 + 0.628157653664655 * x);
    }

    function eval_board(board) {
      board = clone(board);
      let score = 0;
      board.sort((a, b) => b.time - a.time);
      board = board.slice(4);
      let level_cnt = {};
      for (let goal of board) {
        let highest_level = 0;
        for (let level of goal.level) {
          if (level_cnt[level] === undefined) {
            level_cnt[level] = 0;
          }
          highest_level = Math.max(highest_level, level_cnt[level]);
          level_cnt[level]++;
        }
        goal.actual_time = goal.time * att_function(highest_level);
        score += goal.actual_time;
      }
      return score / 2;
    }

    function seedify() {
      ranjs.core.seed(seed);
    }

    function reseed() {
      seed = Math.floor(Math.random() * 100000000);
      upupdate();
    }

    function resetx() {
      output_str = "Output Here";
      gen_length = "medium";
      seed = Math.floor(Math.random() * 100000000);
      bias = 0.6;
      ban_ch = false;
      bans = [];
      pred_length = 0;
      upupdate();
    }

    function gen() {
      downupdate();
      bans = ban_ch ? ['ch'] : [];
      seedify();
      let cnt = 0;
      while (true) {
        let board = gen1();
        let score = eval_board(board);
        let goal_score = board_predict(bias);
        cnt += 1;
        if (Math.abs(score - goal_score) < 3 || cnt >= 1000) {
          output_board(board, score);
          break;
        }
      }
    }

    function gen_copy() {
      gen();
      copyTextToClipboard(document.getElementById("output").value);
    }

    function bftest() {
      seedify();
      let ans = [];
      for (bias = -4; bias <= 4; bias += 0.2) {
        let scores = [];
        for (let i = 0; i < 1000; i++) {
          let board = gen1();
          ranjs.core.shuffle(board);
          scores.push({ score: eval_board(board), board: board });
        }
        let average = scores.reduce((a, b) => a + b.score, 0) / scores.length;
        let stdev = Math.sqrt(scores.reduce((a, b) => a + Math.pow(b.score - average, 2), 0) / scores.length);
        console.log(bias + ", " + average + ", " + board_predict(bias));
      }
    }

    const bias_cast = {'short': -0.2, 'medium': 0.6, 'long': 1.4 };

    function upupdate() {
      document.getElementById("ban-ch").checked = ban_ch;
      document.getElementById("gen_length").value = gen_length;
      if (bias_cast[gen_length]) {
        bias = bias_cast[gen_length];
        document.getElementById("bias").disabled = true;
      } else {
        document.getElementById("bias").disabled = false;
        document.getElementById("bias").value = bias;
      }
      document.getElementById("seed").value = seed;
      document.getElementById("output").value = output_str;
      if (pred_length == 0) {
        document.getElementById("prediction").innerHTML = "";
      } else {
        document.getElementById("prediction").innerHTML = "Length prediction: " + pred_length + " magical units.";
      }
    }

    function downupdate() {
      ban_ch = document.getElementById("ban-ch").checked;
      gen_length = document.getElementById("gen_length").value;
      if (bias_cast[gen_length]) {
        document.getElementById("bias").disabled = true;
        bias = bias_cast[gen_length];
      } else {
        document.getElementById("bias").disabled = false;
        bias = parseFloat(document.getElementById("bias").value);
        bias = Math.min(bias, 10);
        bias = Math.max(bias, -10);
      }
      seed = parseInt(document.getElementById("seed").value);
    }

  </script>
</head>

<body>
  <main class="container">
    <h1>Superliminal Bingo Board Generator</h1>
    <form>
      <label for="gen_length">Length</label>
      <select id="gen_length" required onchange="downupdate()">
        <option value="short">Short (bias -0.2)</option>
        <option value="medium">Medium (bias 0.6)</option>
        <option value="long">Long (bias 1.4)</option>
        <option value="custom">Custom Bias...</option>
      </select>
      <div class="grid">
        <label for="seed">
          Seed
          <input type="number" id="seed" name="seed" placeholder="" oninput="downupdate()">
        </label>

        <label for="bias">
          Bias parameter (-5 to 5)
          <input type="number" min="-5" max="5" id="bias" name="bias" placeholder="" disabled oninput="downupdate()">
        </label>
      </div>
      <fieldset>
        <label for="ban-ch">
          <input type="checkbox" id="ban-ch" name="ban-ch" onclick="downupdate()">
          Disable challenge mode goals
        </label>
      </fieldset>
      <div class="grid">
        <button onclick="gen()" type="button">Generate</button>
        <button onclick="gen_copy()" type="button">Gen & Copy</button>
        <button onclick="reseed(); gen()" type="button">Generate with new seed</button>
        <button onclick="reseed(); gen_copy()" type="button">Gen (new seed) & Copy</button>
      </div>
      <button onclick="resetx()" type="button" class="secondary outline">Reset</button>
      <label for="output">Output (paste into bingosync)</label>
      <textarea name="output" id="output" cols="30" rows="3">Output Here</textarea>
      <div id="prediction"></div>
    </form>
    <footer>
      <hr>
      <p>by <a href="https://etaoinwu.com">EtaoinWu</a></p>
    </footer>
  </main>
  <script>
    resetx();
  </script>
</body>

</html>